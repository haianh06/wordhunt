<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Word Hunt</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif; background:#f3f4f6; margin:0; padding:20px; }
    h1 { text-align:center; margin-bottom:20px; }
    .container{ max-width:1000px; margin:auto; }
    .card{ background:#fff; padding:16px; margin-bottom:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
    .card h2{ margin-top:0; font-size:1.2rem; }
    input,textarea,select{ width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px; }
    button{ background:#4b2c82; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    button:hover{ background:#2196f3 }
    table{ width:100%; border-collapse:collapse; margin-top:12px }
    th,td{ border:1px solid #ddd; padding:6px; text-align:center }
    th{ background:#f9fafb }
    .flex{ display:flex; gap:12px; flex-wrap:wrap; }
    .half{ flex:1; min-width:280px; }
    .btn-delete{ background:#e63946; }
    .btn-delete:hover{ background:#c1121f; }
  </style>
</head>
<body>
  <h1>🛠 Admin Panel - Word Hunt</h1>
  <div class="container">

    <!-- Quản lý TỪ cần tìm -->
    <div class="card">
      <h2>📋 Quản lý danh sách từ</h2>
      <div class="flex">
        <div class="half">
          <label>ID / Số thứ tự</label>
          <input type="number" id="wId" placeholder="VD: 1">
        </div>
        <div class="half">
          <label>Từ (IN HOA, không dấu cách)</label>
          <input type="text" id="wText" placeholder="VD: INNOVATION">
        </div>
      </div>
      <button onclick="addWord()">➕ Thêm/ Cập nhật từ</button>
      <table>
        <thead><tr><th>ID</th><th>Từ</th><th>Hành động</th></tr></thead>
        <tbody id="wordTable"></tbody>
      </table>
    </div>

    <!-- Quản lý người chơi -->
    <div class="card">
      <h2>🏆 Người chơi</h2>
      <button onclick="exportExcel()">⬇ Xuất Excel</button>
      <table>
        <thead><tr><th>Tên</th><th>Email</th><th>Số từ đúng</th><th>Thời gian (s)</th></tr></thead>
        <tbody id="playerTable"></tbody>
      </table>
    </div>

  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbw9O7Wsr59P5g3WJ_XuJmiCRIc0NqLdV5tdogH4rddfJW4ZEmjbbPKmIoUHCnfaVa8bFA/exec";

  // 📌 Load danh sách từ
  async function loadWords(){
    try{
      let res = await fetch(API_URL+"?mode=words");
      let data = await res.json();
      const body = document.getElementById("wordTable");
      body.innerHTML="";
      data.forEach(w=>{
        const id = (typeof w === 'string') ? '' : (w.id ?? w.number ?? '');
        const word = (typeof w === 'string') ? w : (w.word || w.answer || '');
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${id}</td>
          <td>${word}</td>
          <td>
            <button class="btn-delete" onclick="deleteWord(${id||0}, '${word}')">🗑 Xóa</button>
          </td>`;
        body.appendChild(tr);
      });
    }catch(e){
      alert("Không tải được danh sách từ. Kiểm tra API.");
    }
  }

  // 📌 Thêm/ cập nhật từ
  function addWord(){
    const id=document.getElementById("wId").value;
    const word=document.getElementById("wText").value.trim().toUpperCase();
    if(!word){alert("Nhập từ!");return;}
    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        mode:"addWord",
        id:id,
        word:word
      })
    }).then(r=>r.text()).then(t=>{
      alert("✅ Lưu thành công!");
      loadWords();
    });
  }

  // 📌 Xóa từ (ưu tiên theo id, nếu không có id sẽ xoá theo word)
  function deleteWord(id, word){
    if(!confirm("Bạn có chắc muốn xóa '"+word+"'?")) return;
    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        mode:"deleteWord",
        id:id,
        word:word
      })
    }).then(r=>r.text()).then(t=>{
      alert("🗑 Đã xóa!");
      loadWords();
    });
  }

  // 📌 Load người chơi
  async function loadPlayers(){
    let res=await fetch(API_URL);
    let players=await res.json();
    const body=document.getElementById("playerTable");
    body.innerHTML="";
    players
      .sort((a,b)=>b.correct-a.correct || a.duration-b.duration)
      .forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.email)}</td><td>${p.correct}</td><td>${p.duration}</td>`;
        body.appendChild(tr);
      });
  }

  // 📌 Xuất Excel người chơi
  function exportExcel(){
    fetch(API_URL)
      .then(r=>r.json())
      .then(players=>{
        const ws=XLSX.utils.json_to_sheet(players);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,"Players");
        XLSX.writeFile(wb,"wordhunt_players.xlsx");
      });
  }

  function escapeHtml(text){
    return String(text).replace(/[&<>"'`=\\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#47;'}[s]));
  }

  // auto refresh
  loadWords();
  loadPlayers();
  setInterval(loadPlayers,5000);
</script>
</body>
</html>