<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Word Hunt - Talkshow</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#4b2c82; --bg2:#2196f3; --accent:#ff5722; }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;margin:0;padding:20px;min-height:100vh;text-align:center;}
    h1{margin:6px 0 10px;font-size:2.2rem}
    .input-section{margin:12px 0 6px;display:flex;justify-content:center;gap:8px;flex-wrap:wrap;}
    .input-section input{padding:8px 12px;border-radius:8px;border:none;width:220px;max-width:40vw;}
    .btn{background:var(--accent);color:#fff;border:none;padding:9px 14px;border-radius:8px;cursor:pointer;font-weight:600;}
    .btn:hover{transform:scale(1.05)}
    .grid{display:grid;gap:6px;justify-content:center;margin:18px auto;background:rgba(255,255,255,0.08);padding:14px;border-radius:12px;max-width:92vw;}
    .cell{width:40px;height:40px;background:rgba(255,255,255,0.18);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;user-select:none;transition:all .18s;color:#fff;font-size:16px;}
    .cell.active{background:gold;color:#000;transform:scale(1.03)}
    .cell.found{background:#4caf50;color:#fff;box-shadow:0 4px 8px rgba(0,0,0,0.15)}
    @keyframes revealLetter{0%{color:transparent;text-shadow:none;transform:scale(1);}50%{color:gold;text-shadow:0 0 12px gold;transform:scale(1.3);}100%{color:#fff;transform:scale(1);}}
    .cell.reveal{animation:revealLetter 0.6s ease-out forwards;}
    #foundLettersWrap{margin-top:18px;display:flex;justify-content:center;gap:10px;align-items:center;flex-wrap:wrap;}
    .found-letter{display:inline-block;width:48px;height:48px;line-height:48px;border-radius:8px;font-size:28px;font-weight:800;color:gold;background:rgba(255,255,255,0.04);text-align:center;margin:6px;animation:glow 1s ease-in-out 0s 3 alternate;text-shadow:0 0 8px gold,0 0 16px orange;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    @keyframes glow{from{text-shadow:0 0 6px gold,0 0 12px orange;transform:translateY(0);}to{text-shadow:0 0 20px gold,0 0 30px orange;transform:translateY(-6px);}}
    .game-info{display:flex;gap:20px;justify-content:center;align-items:flex-start;margin-top:18px;max-width:1100px;margin-left:auto;margin-right:auto;}
    .leaderboard,.word-list{background:#fff;color:#000;border-radius:12px;padding:14px;flex:1;min-width:260px;}
    .leaderboard h3,.word-list h3{margin:6px 0 12px}
    .word-list ul{list-style:none;padding:0;margin:0}
    .word-list li{padding:6px 0;font-weight:700}
    .word-list li.found{color:#4caf50;text-decoration:line-through}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:#f5f5f5}
    @media(max-width:900px){.cell{width:36px;height:36px;font-size:14px}.found-letter{width:40px;height:40px;line-height:40px;font-size:22px}}
    @media(max-width:760px){.game-info{flex-direction:column;padding:0 8px}.cell{width:32px;height:32px;font-size:13px}.found-letter{width:36px;height:36px;line-height:36px;font-size:20px}}
    #timer{font-weight:700;margin:10px 0}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>Word Hunt - Talkshow</h1>

  <div class="input-section" id="playerForm">
    <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" />
    <input type="email" id="playerEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" />
    <button class="btn" onclick="savePlayer()">B·∫Øt ƒë·∫ßu ch∆°i</button>
  </div>
  <div id="timer">‚è±</div>

  <div id="gameSection" class="hidden">
    <div class="grid" id="grid"></div>

    <div style="margin-top:12px">
      <p style="margin:6px 0">T·ª´ b·∫°n ch·ªçn: <strong id="currentWord"></strong></p>
      <button class="btn" onclick="submitWord()">X√°c nh·∫≠n t·ª´</button>
      <button class="btn" style="background:#3b82f6" onclick="resetSelection()">X√≥a ch·ªçn</button>
      <button class="btn" style="background:#16a34a" onclick="submitGame()">üì© N·ªôp b√†i</button>
    </div>

    <div class="game-info">
      <div class="leaderboard">
        <h3>üèÜ Leaderboard</h3>
        <table>
          <thead><tr><th>H·∫°ng</th><th>T√™n</th><th>S·ªë t·ª´ ƒë√∫ng</th><th>Th·ªùi gian (s)</th></tr></thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <div class="word-list">
        <h3>üìù T√¨m c√°c t·ª´ sau</h3>
        <ul id="wordList"></ul>
      </div>
    </div>

    <div id="foundLettersWrap">
      <div id="foundLetters" aria-live="polite"></div>
    </div>
  </div>

  <div style="margin-top:14px">
    <input type="password" id="adminPassword" placeholder="Admin password" />
    <button class="btn" onclick="checkAdmin()">ƒêƒÉng nh·∫≠p admin</button>
    <span id="adminControls" class="hidden"><button class="btn" style="margin-left:8px" onclick="exportExcel()">Xu·∫•t Excel</button></span>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw9O7Wsr59P5g3WJ_XuJmiCRIc0NqLdV5tdogH4rddfJW4ZEmjbbPKmIoUHCnfaVa8bFA/exec";

    const size = 15;
    const directions = [[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]];
    let grid = [];

    let words = [];
    const gridDiv = document.getElementById('grid');
    const wordListUl = document.getElementById('wordList');
    const currentWordEl = document.getElementById('currentWord');
    const leaderboardBody = document.getElementById('leaderboardBody');
    const timerEl = document.getElementById('timer');
    const foundLettersEl = document.getElementById('foundLetters');

    let selectedCells = [];
    let selectedWord = "";
    let foundWords = [];

    let currentPlayer = null;
    let timerInterval = null;
    let startTime = 0;

    async function loadWords(){
      try{
        const res = await fetch(API_URL+"?mode=words");
        const data = await res.json();
        words = data.map(w => (typeof w === 'string' ? w : (w.word || w.answer || "")).toUpperCase()).filter(Boolean);
      }catch(e){
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch t·ª´. Ki·ªÉm tra API.");
        words = ["HEALTHCARE","EDUCATION","AUTOMATION","COLLABORATION","FUTURE","BAYMAX","AGENT","DATA","INNOVATION","FDS"];
      }
    }

    // ƒë·∫∑t 1 t·ª´ v√†o l∆∞·ªõi
    function placeWord(word){
      for(let attempt=0; attempt<200; attempt++){
        const dir = directions[Math.floor(Math.random()*directions.length)];
        const row = Math.floor(Math.random()*size);
        const col = Math.floor(Math.random()*size);
        let r=row, c=col, ok=true;
        for(const ch of word){
          if(r<0||c<0||r>=size||c>=size){ ok=false; break; }
          if(grid[r][c] && grid[r][c]!==ch){ ok=false; break; }
          r += dir[0]; c += dir[1];
        }
        if(!ok) continue;
        r=row; c=col;
        for(const ch of word){ grid[r][c]=ch; r+=dir[0]; c+=dir[1]; }
        return true;
      }
      return false;
    }

    // x√¢y l∆∞·ªõi v·ªõi reset to√†n b·ªô n·∫øu th·∫•t b·∫°i
    function buildGrid(){
      let success=false;
      while(!success){
        grid = Array.from({length:size}, () => Array(size).fill(""));
        words.sort((a,b)=> b.length-a.length); // t·ª´ d√†i tr∆∞·ªõc
        success = true;
        for(const w of words){
          if(!placeWord(w)){ success=false; break; }
        }
      }
      // ƒëi·ªÅn random
      for(let r=0;r<size;r++){
        for(let c=0;c<size;c++){
          if(!grid[r][c]) grid[r][c] = String.fromCharCode(65+Math.floor(Math.random()*26));
        }
      }
    }

    function renderGrid(){
      gridDiv.innerHTML = "";
      gridDiv.style.gridTemplateColumns = `repeat(${size}, 40px)`;
      for(let r=0;r<size;r++){
        for(let c=0;c<size;c++){
          const div=document.createElement('div');
          div.className='cell';
          div.innerText=grid[r][c];
          div.dataset.r=r; div.dataset.c=c;
          div.addEventListener('click',()=>toggleCell(div));
          gridDiv.appendChild(div);
        }
      }
    }

    function renderWordList(){
      wordListUl.innerHTML="";
      words.forEach(w=>{
        const li=document.createElement('li');
        li.innerText=w; li.id='word-'+w;
        wordListUl.appendChild(li);
      });
    }

    function toggleCell(cell){
      if(!currentPlayer){alert("Vui l√≤ng nh·∫≠p t√™n & email v√† b·∫•m B·∫Øt ƒë·∫ßu ch∆°i.");return;}
      if(cell.classList.contains('active')){
        cell.classList.remove('active');
        selectedCells=selectedCells.filter(x=>x!==cell);
      }else{
        if(cell.classList.contains('found'))return;
        cell.classList.add('active'); selectedCells.push(cell);
      }
      selectedWord=selectedCells.map(c=>c.innerText).join("");
      currentWordEl.innerText=selectedWord;
    }

    function resetSelection(){
      selectedCells.forEach(c=>c.classList.remove('active'));
      selectedCells=[]; selectedWord=""; currentWordEl.innerText="";
    }

    function submitWord(){
      if(!currentPlayer){alert("Vui l√≤ng nh·∫≠p t√™n & email tr∆∞·ªõc khi ch∆°i.");return;}
      const w=selectedWord.toUpperCase();
      if(!w){alert("B·∫°n ch∆∞a ch·ªçn ch·ªØ n√†o.");return;}
      if(words.includes(w) && !foundWords.includes(w)){
        foundWords.push(w);
        const li=document.getElementById('word-'+w);
        if(li) li.classList.add('found');
        selectedCells.forEach((c,idx)=>{
          setTimeout(()=>{
            c.classList.add('found','reveal');
            setTimeout(()=>c.classList.remove('reveal'),700);
          },idx*220);
        });
        const firstLetter=w[0];
        if(!Array.from(foundLettersEl.children).some(ch=>ch.dataset.word===w)){
          const span=document.createElement('span');
          span.className="found-letter";
          span.innerText=firstLetter;
          span.dataset.word=w;
          foundLettersEl.appendChild(span);
        }
        saveAnswer(w,"ƒê√∫ng"); currentPlayer.Correct++;
        if(currentPlayer.Correct===words.length){stopTimerAndFinish();}
        updateLeaderboard();
      }else{saveAnswer(w,"Sai");alert("‚úò Sai ho·∫∑c ƒë√£ t√¨m r·ªìi.");}
      resetSelection();
    }

    function submitGame(){
      if(!currentPlayer){alert("Vui l√≤ng nh·∫≠p t√™n & email tr∆∞·ªõc khi ch∆°i.");return;}
      clearInterval(timerInterval);
      document.querySelectorAll(".cell").forEach(cell=>{cell.style.pointerEvents="none";});
      fetch(API_URL,{method:"POST",body:JSON.stringify({mode:"submit",name:currentPlayer.Name,email:currentPlayer.Email,correct:currentPlayer.Correct,duration:currentPlayer.Duration,answers:currentPlayer.Answers})});
      alert("üì© B·∫°n ƒë√£ n·ªôp b√†i! K·∫øt qu·∫£ ƒë∆∞·ª£c l∆∞u."); updateLeaderboard();
    }

    function savePlayer(){
      const name=document.getElementById('playerName').value.trim();
      const email=document.getElementById('playerEmail').value.trim();
      if(!name||!email){alert("Vui l√≤ng nh·∫≠p t√™n v√† email.");return;}
      currentPlayer={Name:name,Email:email,Start:new Date().toLocaleString(),Answers:[],Correct:0,Duration:0};
      document.getElementById('playerForm').classList.add('hidden');
      document.getElementById('gameSection').classList.remove('hidden');
      clearInterval(timerInterval); startTime=Date.now();
      timerInterval=setInterval(updateTimer,1000);
    }

    function saveAnswer(word,status){
      if(!currentPlayer)return;
      currentPlayer.Answers.push({Word:word,Result:status});
    }

    function updateTimer(){
      const elapsed=Math.floor((Date.now()-startTime)/1000);
      currentPlayer.Duration=elapsed;
      timerEl.innerText="‚è± Th·ªùi gian: "+elapsed+" gi√¢y";
    }

    function stopTimerAndFinish(){
      if(timerInterval) clearInterval(timerInterval);
      timerEl.innerText="‚è± Ho√†n th√†nh trong: "+currentPlayer.Duration+" gi√¢y";
      submitGame();
    }

    function updateLeaderboard(){
      fetch(API_URL).then(r=>r.json()).then(players=>{
        const body=document.getElementById('leaderboardBody'); body.innerHTML="";
        players.sort((a,b)=> b.correct-a.correct || a.duration-b.duration)
        .forEach((p,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(p.name)}</td><td>${p.correct}</td><td>${p.duration}</td>`;
          body.appendChild(tr);
        });
      }).catch(()=>{});
    }

    function checkAdmin(){
      const pass=document.getElementById('adminPassword').value;
      if(pass==='fdsclub2024'){document.getElementById('adminControls').classList.remove('hidden');alert("ƒêƒÉng nh·∫≠p admin th√†nh c√¥ng");}
      else{alert("Sai m·∫≠t kh·∫©u admin");}
    }

    function exportExcel(){
      fetch(API_URL).then(r=>r.json()).then(players=>{
        const ws=XLSX.utils.json_to_sheet(players);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,"Players");
        XLSX.writeFile(wb,"wordhunt_players.xlsx");
      });
    }

    function escapeHtml(text){
      return String(text).replace(/[&<>"'`=\/]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#47;'}[s]));
    }

    (async function init(){
      await loadWords();
      buildGrid(); renderGrid(); renderWordList();
      updateLeaderboard(); setInterval(updateLeaderboard,5000);
    })();
  </script>
</body>
</html>
